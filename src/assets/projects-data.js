// Projects Data - Easy to maintain and update
const projectsData = [
    {
        id: 1,
        name: "WOODVIEW COMMONS FLATS",
        location: "Ann Arbor, MI",
        type: "Multifamily Units & Amenities",
        details: "156 Units, New Construction",
        scopes: "Granite Countertops",
        materials: "Granite Countertops, Sink Fixtures",
        client: "Williams Distributing/Rohde Construction",
        dates: "Nov 2024 - March 2025",
        images: [
            "images/Previous Jobs/1. Woodview Commons/(Kitchen 1) woodview-commons-ann-arbor-mi-building-photo.jpg",
            "images/Previous Jobs/1. Woodview Commons/(Kitchen 2) woodview-commons-ann-arbor-mi-building-photo.jpg",
            "images/Previous Jobs/1. Woodview Commons/(Kitchen 3) woodview-commons-ann-arbor-mi-building-photo.jpg",
            "images/Previous Jobs/1. Woodview Commons/(Kitchen 4) woodview-commons-ann-arbor-mi-building-photo.jpg",
            "images/Previous Jobs/1. Woodview Commons/(Bath 1) woodview-commons-ann-arbor-mi-building-photo.jpg",
            "images/Previous Jobs/1. Woodview Commons/(Bath 2) woodview-commons-ann-arbor-mi-building-photo.jpg",
            "images/Previous Jobs/1. Woodview Commons/f7a180_58b201d1f2524e57921183cc3bbd7fe2~mv2.avif",
            "images/Previous Jobs/1. Woodview Commons/f7a180_c95f71bc1b22468dbebcea6aea1be972~mv2.avif",
            "images/Previous Jobs/1. Woodview Commons/f7a180_da4f4164b25d435eadbfc9b81a97ca1d~mv2.avif",
            "images/Previous Jobs/1. Woodview Commons/f7a180_0c74b0b201be419b8e7a823bf3dea9c8~mv2.avif",
            "images/Previous Jobs/1. Woodview Commons/(Site Overview) woodview-commons-ann-arbor.jpg",
            "images/Previous Jobs/1. Woodview Commons/(BLDG. Overview) woodview-commons-ann-arbor.jpg"
        ]
    },
    {
        id: 2,
        name: "SEATON PLACE APARTMENTS",
        location: "Chesterfield, MI",
        type: "Multifamily Units & Amenities",
        details: "100 Units, New Construction",
        scopes: "Quartz Countertops, Casework & Finish Trim Carpentry Installation",
        materials: "Quartz Countertops, Sink Fixtures, Cabinetry",
        client: "Icon Development, Inc",
        dates: "Jan 2024 - Dec 2026",
        images: ["placeholder", "placeholder", "placeholder"]
    },
    {
        id: 3,
        name: "PLYMOUTH WALK APARTMENTS",
        location: "Plymouth Township, MI",
        type: "Multifamily Units & Amenities",
        details: "268 Units, New Construction",
        scopes: "Quartz Countertops",
        materials: "Quartz Countertops, Sink Fixtures",
        client: "Sachse Construction",
        dates: "Jan 2026 - Nov 2026",
        images: ["placeholder", "placeholder", "placeholder"]
    },
    {
        id: 4,
        name: "WALDON PONDS APARTMENTS",
        location: "Marshall, MI",
        type: "Multifamily Units & Amenities",
        details: "100 Units, Renovation",
        scopes: "Quartz Countertops, Casework & Finish Trim Carpentry Installation",
        materials: "Quartz Countertops, Sink Fixtures, Cabinetry",
        client: "Icon Development, Inc",
        dates: "Mar 2025 - April 2025",
        images: ["placeholder", "placeholder", "placeholder"]
    },
    {
        id: 5,
        name: "IRONWORKS APARTMENTS",
        location: "Kalamazoo, MI",
        type: "Multifamily Units & Amenities",
        details: "82 Units, New Construction",
        scopes: "Granite Countertops",
        materials: "Granite Countertops, Sink Fixtures",
        client: "Williams Distributing",
        dates: "March 2025 - July 2025",
        images: ["placeholder", "placeholder", "placeholder"]
    },
    {
        id: 6,
        name: "BRIGHTDAWN APARTMENTS",
        location: "Ann Arbor, MI",
        type: "Multifamily Units & Amenities",
        details: "120 Units, New Construction",
        scopes: "Quartz Countertops",
        materials: "Quartz Countertops, Sink Fixtures",
        client: "Braun Construction Group",
        dates: "April 2025 - Sept 2025",
        images: ["placeholder", "placeholder", "placeholder"]
    },
    {
        id: 7,
        name: "THE PRESERVE ON ASH",
        location: "Detroit, MI",
        type: "Multifamily Units & Amenities",
        details: "73 Units, New Construction",
        scopes: "Quartz Countertops",
        materials: "Quartz Countertops",
        client: "Sachse Construction",
        dates: "Apr 2025 - Aug 2025",
        images: ["placeholder", "placeholder", "placeholder"]
    },
    {
        id: 8,
        name: "ICON DEVELOPMENT OFFICE RENOVATION",
        location: "Clinton Twp, MI",
        type: "Office Renovation",
        details: "Commercial Office Space",
        scopes: "Quartz Countertops, Casework & Finish Trim Carpentry Installation",
        materials: "Quartz Countertops, Sink Fixtures, Cabinetry",
        client: "Icon Development, Inc",
        dates: "April 2025 - May 2025",
        images: ["placeholder", "placeholder", "placeholder"]
    },
    {
        id: 9,
        name: "FREEWHEEL APARTMENTS",
        location: "Marquette, MI",
        type: "Multifamily Units & Amenities",
        details: "39 Units, New Construction",
        scopes: "Quartz Countertops",
        materials: "Quartz Countertops",
        client: "Williams Distributing",
        dates: "May 2025 - Aug 2025",
        images: [
            "images/Previous Jobs/10. Freewheel Apartments/freewheel-apartments-marquette-mi-primary-photo.png"
        ]
    },
    {
        id: 10,
        name: "450 AMSTERDAM APARTMENTS",
        location: "Detroit, MI",
        type: "Multifamily Units & Amenities",
        details: "92 Units, New Construction",
        scopes: "Quartz Countertops",
        materials: "Quartz Countertops, Sink Fixtures",
        client: "Greatwater Opportunity Capital/Jonna Construction Company",
        dates: "Mar 2025 - May 2025",
        images: ["placeholder", "placeholder", "placeholder"]
    },
    {
        id: 11,
        name: "STATE & MAIN APARTMENTS",
        location: "Zeeland, MI",
        type: "Multifamily Units & Amenities",
        details: "22 Units, New Construction",
        scopes: "Quartz Countertops",
        materials: "Quartz Countertops, Sink Fixtures",
        client: "Williams Distributing",
        dates: "April 2025 - May 2025",
        images: ["placeholder", "placeholder", "placeholder"]
    },
    {
        id: 12,
        name: "HIGGINBOTHAM GARDEN APARTMENTS",
        location: "Detroit, MI",
        type: "Multifamily Units & Amenities",
        details: "63 Units, New Construction",
        scopes: "Quartz Countertops",
        materials: "Quartz Countertops",
        client: "Ronnisch Construction Group",
        dates: "Jan 2026 - May 2026",
        images: [
            "images/Previous Jobs/19. Higgenbotham Garden Apartments/view-of-kitchen.png",
            "images/Previous Jobs/19. Higgenbotham Garden Apartments/view-from-north-parking-lot.png",
            "images/Previous Jobs/19. Higgenbotham Garden Apartments/view-from-indiana.png"
        ]
    },
    {
        id: 13,
        name: "HIGGINBOTHAM SCHOOL APARTMENTS",
        location: "Detroit, MI",
        type: "Multifamily Units & Amenities",
        details: "85 Units, New Construction",
        scopes: "Quartz Countertops",
        materials: "Quartz Countertops",
        client: "Ronnisch Construction Group",
        dates: "Feb 2026 - June 2026",
        images: [
            "images/Previous Jobs/20. Higgenbotham School Apartments/commons-render.png",
            "images/Previous Jobs/20. Higgenbotham School Apartments/commons-render2.png",
            "images/Previous Jobs/20. Higgenbotham School Apartments/1732052558818.webp",
            "images/Previous Jobs/20. Higgenbotham School Apartments/Higginbotham rendering.jpg"
        ]
    },
    {
        id: 14,
        name: "LEE CREST APARTMENTS",
        location: "Detroit, MI",
        type: "Multifamily Units & Amenities",
        details: "100 Units, New Construction",
        scopes: "Quartz Countertops",
        materials: "Quartz Countertops, Sink Fixtures",
        client: "Greatwater Opportunity Capital/The Monahan Company",
        dates: "Jan 2025 - Feb 2025",
        images: [
            "images/Previous Jobs/11. Lee Crest Apartments/Site View_LeeCrest.jpg"
        ]
    },
    {
        id: 15,
        name: "CHATHAM APARTMENTS",
        location: "Detroit, MI",
        type: "Multifamily Units & Amenities",
        details: "73 Units, New Construction",
        scopes: "Quartz Countertops",
        materials: "Quartz Countertops, Sink Fixtures",
        client: "Greatwater Opportunity Capital/The Monahan Company",
        dates: "Mar 2025 - May 2025",
        images: ["placeholder", "placeholder", "placeholder"]
    },
    {
        id: 16,
        name: "DETROIT COMMERCIAL BUILDING",
        location: "Detroit, MI",
        type: "Commercial Building",
        details: "Commercial Space",
        scopes: "Casework & Finish Trim Carpentry Installation",
        materials: "",
        client: "Icon Development, Inc",
        dates: "Sep 2024 - Oct 2024",
        images: ["placeholder", "placeholder", "placeholder"]
    },
    {
        id: 17,
        name: "TERRA STATION APARTMENTS",
        location: "Hudsonville, MI",
        type: "Multifamily Units & Amenities",
        details: "141 Units, New Construction",
        scopes: "Quartz Countertops",
        materials: "Quartz Countertops, Sink Fixtures",
        client: "Williams Distributing",
        dates: "Aug 2025 - Dec 2025",
        images: ["placeholder", "placeholder", "placeholder"]
    },
    {
        id: 18,
        name: "BALDWIN WOODS APARTMENTS",
        location: "Grand Blanc, MI",
        type: "Multifamily Units & Amenities",
        details: "89 Units, New Construction",
        scopes: "Quartz Countertops",
        materials: "Quartz Countertops, Sink Fixtures",
        client: "Sachse Construction",
        dates: "Jun 2025 - Nov 2025",
        images: ["placeholder", "placeholder", "placeholder"]
    },
    {
        id: 19,
        name: "3740 2ND AVE APARTMENTS",
        location: "Detroit, MI",
        type: "Multifamily Units & Amenities",
        details: "57 Units, New Construction",
        scopes: "Quartz Countertops",
        materials: "Quartz Countertops, Sink Fixtures",
        client: "Greatwater Opportuniy Capital/The Monahan Company",
        dates: "Jan 2025 - Feb 2025",
        images: [
            "images/Previous Jobs/4. 3740 2nd Ave Apartments/Kitchen1 VIEW_3740 Apartments.jpg",
            "images/Previous Jobs/4. 3740 2nd Ave Apartments/bath1 VIEW_3740 Apartments.jpg",
            "images/Previous Jobs/4. 3740 2nd Ave Apartments/SITE VIEW_3740 Apartments.jpg"
        ]
    },
    {
        id: 20,
        name: "TEAM WELLNESS",
        location: "Detroit, MI",
        type: "Commercial",
        details: "Healthcare Facility",
        scopes: "Quartz Countertops",
        materials: "Quartz Countertops, Sink Fixtures",
        client: "Icon Development, Inc",
        dates: "Dec 2024 - Jan 2025",
        images: ["placeholder", "placeholder", "placeholder"]
    },
    {
        id: 21,
        name: "PALMS APARTMENTS",
        location: "Detroit, MI",
        type: "Multifamily Units & Amenities",
        details: "61 Units, New Construction",
        scopes: "Quartz Countertops",
        materials: "Quartz Countertops, Sink Fixtures",
        client: "Greatwater Opportunity Capital",
        dates: "Dec 2024 - Feb 2025",
        images: ["placeholder", "placeholder", "placeholder"]
    },
    {
        id: 22,
        name: "2135 HUBBARD",
        location: "Detroit, MI",
        type: "Multifamily Units & Amenities",
        details: "31 Units, New Construction",
        scopes: "Quartz Countertops",
        materials: "Quartz Countertops, Sink Fixtures",
        client: "Greatwater Opportunity Capital/Artisian Contractors",
        dates: "Aug 2024 - Oct 2024",
        images: [
            "images/Previous Jobs/14. 2135 Hubbard/mavor-apartments-detroit-mi-building-photo.jpg",
            "images/Previous Jobs/14. 2135 Hubbard/mavor-apartments-detroit-mi-building-photo (1).jpg",
            "images/Previous Jobs/14. 2135 Hubbard/mavor-apartments-detroit-mi-building-photo (2).jpg"
        ]
    },
    {
        id: 23,
        name: "25 E. PALMER (BARLUM APARTMENTS)",
        location: "Detroit, MI",
        type: "Multifamily Units & Amenities",
        details: "30 Units, New Construction",
        scopes: "Quartz Countertops",
        materials: "Quartz Countertops, Sink Fixtures",
        client: "Greatwater Opportunity Capital",
        dates: "Sep 2024 - Oct 2024",
        images: [
            "images/Previous Jobs/16. 25 E. Palmer (Barlum Apartments)/the-barlum-detroit-mi-primary-photo.jpg",
            "images/Previous Jobs/16. 25 E. Palmer (Barlum Apartments)/the-barlum-detroit-mi-building-photo.jpg",
            "images/Previous Jobs/16. 25 E. Palmer (Barlum Apartments)/the-barlum-detroit-mi-building-photo (1).jpg",
            "images/Previous Jobs/16. 25 E. Palmer (Barlum Apartments)/the-barlum-detroit-mi-building-photo (2).jpg"
        ]
    }
];

// Function to generate project HTML
function generateProjectHTML(project) {
    const imageSlides = project.images.map((image, index) => {
        if (image === "placeholder") {
            return `<div class="carousel-slide">
                        <p>Image coming soon</p>
                    </div>`;
        } else {
            return `<div class="carousel-slide">
                        <img src="../../${image}" alt="${project.name}" loading="lazy">
                    </div>`;
        }
    }).join('');

    return `
    <!-- Project ${project.id}: ${project.name} -->
    <section class="project-spotlight">
        <div class="container">
            <div class="spotlight-box">
                <h2>${project.name}</h2>
                <div class="project-details">
                    <p><strong>Location:</strong> ${project.location}</p>
                    <p><strong>Type:</strong> ${project.type}</p>
                    <p><strong>Details:</strong> ${project.details}</p>
                    <p><strong>Scopes Performed:</strong> ${project.scopes}</p>
                    <p><strong>Materials Supplied:</strong> ${project.materials}</p>
                    <p><strong>Client:</strong> ${project.client}</p>
                    <p><strong>Project Start/Finish:</strong> ${project.dates}</p>
                </div>
            </div>
            <div class="project-gallery">
                <div class="carousel-container">
                    <button class="carousel-btn carousel-prev" aria-label="Previous image">‹</button>
                    <div class="carousel-track">
                        ${imageSlides}
                    </div>
                    <button class="carousel-btn carousel-next" aria-label="Next image">›</button>
                </div>
            </div>
        </div>
    </section>`;
}

// Function to render all projects
function renderProjects(filteredProjects = null) {
    const projectsContainer = document.getElementById('projects-container');
    if (projectsContainer) {
        const projectsToRender = filteredProjects || projectsData;
        projectsContainer.innerHTML = projectsToRender.map(project => generateProjectHTML(project)).join('');

        // Re-initialize carousel functionality after rendering
        initializeCarousels();

        // Add click listeners to carousel images for modal functionality
        if (window.addImageClickListeners) {
            window.addImageClickListeners();
        }
    }
}

// Function to initialize carousel functionality
function initializeCarousels() {
    const carousels = document.querySelectorAll('.carousel-container');

    carousels.forEach(carousel => {
        const track = carousel.querySelector('.carousel-track');
        const slides = [...carousel.querySelectorAll('.carousel-slide')];
        const prevBtn = carousel.querySelector('.carousel-prev');
        const nextBtn = carousel.querySelector('.carousel-next');

        if (!track || slides.length === 0) return;

        const slidesToShow = () =>
            window.innerWidth <= 768 ? 1 : window.innerWidth <= 1024 ? 2 : 3;

        const stepPx = () => {
            // Get the exact width of one slide including padding and margins
            const first = slides[0];
            if (!first) return 0;

            const rect = first.getBoundingClientRect();
            const computedStyle = window.getComputedStyle(first);

            // Include padding and margins for precise calculation
            const paddingLeft = parseFloat(computedStyle.paddingLeft);
            const paddingRight = parseFloat(computedStyle.paddingRight);
            const marginLeft = parseFloat(computedStyle.marginLeft);
            const marginRight = parseFloat(computedStyle.marginRight);

            const step = Math.round(rect.width + paddingLeft + paddingRight + marginLeft + marginRight);

            // Calculate step size for carousel navigation

            return step;
        };

        const maxIndex = () => Math.max(0, slides.length - slidesToShow());
        const curIndex = () => {
            const step = stepPx();
            return step > 0 ? Math.round(track.scrollLeft / step) : 0;
        };

        const updateArrows = () => {
            const i = curIndex();
            const max = maxIndex();

            // Update arrow visibility
            if (prevBtn) {
                prevBtn.style.display = i <= 0 ? 'none' : 'flex';
                prevBtn.style.opacity = i <= 0 ? '0' : '1';
            }
            if (nextBtn) {
                nextBtn.style.display = i >= max ? 'none' : 'flex';
                nextBtn.style.opacity = i >= max ? '0' : '1';
            }
        };

        // Navigation functions
        const next = () => {
            const current = curIndex();
            const max = maxIndex();
            const step = stepPx();

            if (current < max) {
                track.scrollBy({ left: step, behavior: 'smooth' });
            }
        };

        const prev = () => {
            const current = curIndex();
            const step = stepPx();

            if (current > 0) {
                track.scrollBy({ left: -step, behavior: 'smooth' });
            }
        };

        // Event listeners
        nextBtn?.addEventListener('click', next);
        prevBtn?.addEventListener('click', prev);

        // Keyboard navigation
        carousel.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') prev();
            if (e.key === 'ArrowRight') next();
        });

        // Touch/swipe support
        let startX = 0;
        let startScrollLeft = 0;

        carousel.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            startScrollLeft = track.scrollLeft;
        }, { passive: true });

        carousel.addEventListener('touchend', (e) => {
            const endX = e.changedTouches[0].clientX;
            const diff = startX - endX;
            const threshold = stepPx() * 0.3; // 30% of slide width to trigger

            if (Math.abs(diff) > threshold) {
                if (diff > 0) {
                    next(); // Swipe left
                } else {
                    prev(); // Swipe right
                }
            }
        }, { passive: true });

        // Keep arrows in sync while user drags/swipes
        track.addEventListener('scroll', () => {
            requestAnimationFrame(updateArrows);
        }, { passive: true });

        // Handle resize with proper snapping
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                const current = curIndex();
                const step = stepPx();
                const targetScroll = current * step;

                // Snap to the correct position
                track.scrollTo({
                    left: targetScroll,
                    behavior: 'auto'
                });

                updateArrows();
            }, 150);
        });

        // Initial setup
        updateArrows();
    });
}

// Filter functionality
let selectedType = '';
let selectedScopes = [];

// Function to get unique types from projects
function getUniqueTypes() {
    const types = projectsData.map(project => project.type);
    return [...new Set(types)].sort();
}

// Function to get unique scopes from projects
function getUniqueScopes() {
    const allScopes = projectsData.map(project => project.scopes);
    const scopeList = allScopes.flatMap(scopes =>
        scopes.split(',').map(scope => scope.trim())
    );
    return [...new Set(scopeList)].sort();
}

// Function to populate filter options
function populateFilters() {
    // Populate type filter
    const typeFilter = document.getElementById('type-filter');
    if (typeFilter) {
        const types = getUniqueTypes();
        types.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            typeFilter.appendChild(option);
        });
    }

    // Populate scopes filter
    const scopesDropdown = document.getElementById('scopes-dropdown');
    if (scopesDropdown) {
        const scopes = getUniqueScopes();
        scopes.forEach(scope => {
            const option = document.createElement('div');
            option.className = 'multi-select-option';
            option.innerHTML = `
                <input type="checkbox" id="scope-${scope.replace(/\s+/g, '-')}" value="${scope}">
                <label for="scope-${scope.replace(/\s+/g, '-')}">${scope}</label>
            `;
            scopesDropdown.appendChild(option);
        });
    }
}

// Function to filter projects
function filterProjects() {
    let filtered = projectsData;

    // Filter by type
    if (selectedType) {
        filtered = filtered.filter(project => project.type === selectedType);
    }

    // Filter by scopes
    if (selectedScopes.length > 0) {
        filtered = filtered.filter(project => {
            const projectScopes = project.scopes.split(',').map(scope => scope.trim());
            return selectedScopes.some(selectedScope =>
                projectScopes.includes(selectedScope)
            );
        });
    }

    renderProjects(filtered);
}

// Function to update scopes display
function updateScopesDisplay() {
    const scopesDisplay = document.getElementById('scopes-display');
    if (scopesDisplay) {
        if (selectedScopes.length === 0) {
            scopesDisplay.innerHTML = '<span class="placeholder">SELECT SCOPES</span>';
        } else {
            const selectedItems = selectedScopes.map(scope =>
                `<span class="selected-item">${scope}<span class="remove" data-scope="${scope}">×</span></span>`
            ).join('');
            scopesDisplay.innerHTML = `<div class="selected-items">${selectedItems}</div>`;
        }
    }
}

// Function to initialize filter event listeners
function initializeFilters() {
    // Type filter
    const typeFilter = document.getElementById('type-filter');
    if (typeFilter) {
        typeFilter.addEventListener('change', (e) => {
            selectedType = e.target.value;
            filterProjects();
        });
    }

    // Scopes multi-select
    const scopesDisplay = document.getElementById('scopes-display');
    const scopesDropdown = document.getElementById('scopes-dropdown');

    if (scopesDisplay && scopesDropdown) {
        // Toggle dropdown
        scopesDisplay.addEventListener('click', () => {
            scopesDropdown.classList.toggle('active');
            scopesDisplay.classList.toggle('active');
        });

        // Handle scope selection
        scopesDropdown.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                const scope = e.target.value;
                if (e.target.checked) {
                    if (!selectedScopes.includes(scope)) {
                        selectedScopes.push(scope);
                    }
                } else {
                    selectedScopes = selectedScopes.filter(s => s !== scope);
                }
                updateScopesDisplay();
                filterProjects();
            }
        });

        // Handle remove scope
        scopesDisplay.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove')) {
                const scope = e.target.dataset.scope;
                selectedScopes = selectedScopes.filter(s => s !== scope);
                updateScopesDisplay();

                // Uncheck the checkbox
                const checkbox = document.getElementById(`scope-${scope.replace(/\s+/g, '-')}`);
                if (checkbox) {
                    checkbox.checked = false;
                }

                filterProjects();
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!scopesDisplay.contains(e.target) && !scopesDropdown.contains(e.target)) {
                scopesDropdown.classList.remove('active');
                scopesDisplay.classList.remove('active');
            }
        });
    }

    // Clear filters button
    const clearFiltersBtn = document.getElementById('clear-filters');
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', () => {
            selectedType = '';
            selectedScopes = [];

            // Reset type filter
            if (typeFilter) {
                typeFilter.value = '';
            }

            // Reset scopes checkboxes
            const checkboxes = scopesDropdown.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });

            updateScopesDisplay();
            filterProjects();
        });
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function () {
    populateFilters();
    initializeFilters();
    renderProjects();
});
